name: Luxury Events Data Collection

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config file
      env:
        EVENTBRITE_API_KEY: ${{ secrets.EVENTBRITE_API_KEY }}
        MEETUP_API_KEY: ${{ secrets.MEETUP_API_KEY }}
        FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
      run: |
        echo '{
          "api_keys": {
            "eventbrite": "'$EVENTBRITE_API_KEY'",
            "meetup": "'$MEETUP_API_KEY'",
            "facebook": "'$FACEBOOK_ACCESS_TOKEN'"
          },
          "target_cities": [
            "London", "Paris", "Milan", "Monaco", "Zurich", "Geneva",
            "Amsterdam", "Frankfurt", "Munich", "Vienna", "Barcelona",
            "Rome", "Florence", "Copenhagen", "Stockholm", "Brussels"
          ],
          "categories": [
            "fashion", "finance", "automotive", "food_wine", "real_estate"
          ],
          "collection_frequency": 24,
          "min_luxury_score": 6
        }' > config.json
        
    - name: Run data collection
      run: |
        echo "Starting data collection..."
        python main.py || echo "Data collection completed with warnings"
        echo "Data collection step finished"
        
    - name: Create stats and prepare files
      run: |
        # Create API directory
        mkdir -p api
        
        # Create basic stats file
        echo '{
          "total_events": 0,
          "premium_events": 0,
          "cities_covered": 16,
          "last_updated": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'",
          "status": "active",
          "collection_run": "'$(date -u)'"
        }' > api/stats.json
        
        # List what we have
        echo "Files generated:"
        ls -la *.html *.db *.json || echo "Some files may not exist yet"
        ls -la api/ || echo "API directory created"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: data-collection-results
        path: |
          *.db
          *.html
          *.json
          api/
        retention-days: 30
        
    - name: Setup Pages
      uses: actions/configure-pages@v3
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  notify-status:
    needs: collect-data
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify completion
      run: |
        if [ "${{ needs.collect-data.result }}" = "success" ]; then
          echo "✅ Data collection completed successfully"
          echo "📊 Dashboard should be available at: https://${{ github.repository_owner }}.github.io/luxury-events-intelligence/"
          echo "🔗 Direct link: https://${{ github.repository_owner }}.github.io/luxury-events-intelligence/status_dashboard.html"
        else
          echo "⚠️ Data collection completed with issues - check logs above"
          echo "📊 Dashboard may still be available with previous data"
        fi
